data = [
	{date: new Date(2020, 1-1, 0), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 1), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 2), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 3), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 4), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 5), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 6), value: Math.random(1000) * 1000, events: [{type: "macro", string: "Started some TJ"}, {type: "micro", string: "PB!"}]},
	{date: new Date(2020, 1-1, 7), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 8), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 9), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 10), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 11), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 12), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 13), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 14), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 15), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 16), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 17), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 18), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 19), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 20), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 21), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 22), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 23), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 24), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 25), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 26), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 27), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 28), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 29), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 1-1, 30), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 01), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 02), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 03), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 04), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 05), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 06), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 07), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 08), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 09), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 10), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 11), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 12), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 13), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 14), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 15), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 16), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 17), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 18), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 19), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 20), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 2-1, 21), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 01), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 02), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 03), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 04), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 05), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 06), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 07), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 08), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 09), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 10), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 11), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 12), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 13), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 14), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 15), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 16), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 17), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 18), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 19), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 20), value: Math.random(1000) * 1000, events: []},
	{date: new Date(2020, 4-1, 21), value: Math.random(1000) * 1000, events: []},
]

day = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]

width = 1000
cellSize = 18
height = cellSize * 9

max = d3.quantile(data.map(d => Math.abs(d.value)).sort(d3.ascending), 1000)
color = d3.scaleSequential(d3.interpolateBlues).domain([0, max]);

// group the data by years
years = d3.groups(data, d => d.date.getUTCFullYear()).reverse()

var svg = d3.select("body").append("svg")
	.attr("viewBox", [0, 0, width, height * years.length])
	.attr("font-size", 10);

// append g for each year
var year = svg.append("g")
	.data(years)
	.join("g")
	.attr("transform", (d, i) => `translate(40.5,${height * i + cellSize * 2})`);

// add year text
year.append("text")
	.attr("x", -10)
	.attr("y", -5)
	.attr("font-weight", "bold")
	.attr("text-anchor", "end")
	.text(([key]) => key);

year.append("g")
	.attr("text-anchor", "end")
	.selectAll("text")
	.data(day)
	.join("text")
	.attr("x", -10)
	.attr("y", (d, i) => (i + 0.5) * cellSize)
	.attr("dy", "0.31em")
	.text(d => d)

var month = year.append("g")
	.selectAll("g")
	.data(month)
	.join("g")

// add month text
month.append("text")
	.attr("x", (d, i) => {
		return d3.utcSunday.count(new Date(2020, 0, 0), new Date(2020, i + 1, 0)) * cellSize
	})
	.attr("y", -5)
	.text(d => d)

// function monthPath(t0) {
// 	console.log(t0)
// 	var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),
// 		d0 = t0.getDay(), w0 = d3.timeWeek.count(d3.timeYear(t0), t0),
// 		d1 = t1.getDay(), w1 = d3.timeWeek.count(d3.timeYear(t1), t1);
// 	return "M" + (((w0 + 1) * cellSize) - 1) + "," + (d0 * cellSize) - 1
// 		+ "H" + ((w0 * cellSize) - 1) + "V" + ((7 * cellSize) - 1)
// 		+ "H" + w1 * cellSize + "V" + (d1 + 1) * cellSize
// 		+ "H" + (((w1 + 1) * cellSize) -1 ) + "V" + 0
// 		+ "H" + (((w0 + 1) * cellSize) - 1) + "Z";
// }

// year.append("g")
// 	.selectAll("g")
// 	.data(month)
// 	.join("g")
// 	.append("path")
// 	.attr("stroke-width", 1)
// 	.attr("fill", "none")
// 	.attr("stroke", "black")
// 	.attr("d", (d, i) => { return monthPath(new Date(2020, i, 0)) })

var mouseover = (event, d) => {
	d3.select(event.currentTarget)
	.transition()
	.style("stroke", "black");

	tooltip.transition().duration(200).style("opacity", 1);
	tooltip.html(d.date)
	.style("left", d3.select(event.currentTarget).attr("x")  + "px")
	.style("top",  d3.select(event.currentTarget).attr("y") + "px")
}

var mouseout = (event, d) => {
	d3.select(event.currentTarget)
	.transition()
	.style("stroke", "none");

	tooltip.transition().duration(200).style("opacity", 0);
}

var tooltip = d3.select("body").append("div")
	.attr("class", "tooltip")
	.style("z-index", 10)
	.style("opacity", 0)
	.style("position", "absolute")

year.append("g")
	.selectAll("rect")
	.data(([year, values]) => {
		return values
	})
	.join("rect")
	.attr("width", cellSize - 2)
	.attr("height", cellSize - 2)
	.attr("rx", 3)
	.attr("ry", 3)
	.attr("x", d => {
		return d3.utcSunday.count(d3.utcYear(d.date), d.date) * cellSize
	})
	.attr("y", d => {
		return d.date.getUTCDay() * cellSize
	})
	.style("fill", d => {
		return color(d.value)
	})
	.style("stroke-width", 2)
	.on("mouseover", (event, d) => mouseover(event, d))
	.on("mouseout", (event, d) => mouseout(event, d))

//var weekday = "sunday"

//// https://github.com/d3/d3-scale-chromatic/blob/v2.0.0/README.md#interpolatePiYG
//// https://github.com/d3/d3-time-format/blob/v3.0.0/README.md#utcFormat
//formatMonth = d3.utcFormat("%b")
//formatDay = i => "SMTWTFS"[i]
//formatDate = d3.utcFormat("%x")

////https://github.com/d3/d3-format/blob/v2.0.0/README.md#format
//formatValue = d3.format("+.2%")

//cellSize = 18


//function pathMonth(t) {
//  const n = 7;
//  const d = Math.max(0, Math.min(n, countDay(t.getUTCDay())));
//  const w = timeWeek.count(d3.utcYear(t), t);
//  return `${d === 0 ? `M${w * cellSize},0`
//      : d === n ? `M${(w + 1) * cellSize},0`
//      : `M${(w + 1) * cellSize},0V${d * cellSize}H${w * cellSize}`}V${n * cellSize}`;
//}

//countDay = weekday === "sunday" ? i => i : i => (i + 6) % 7
//timeWeek = weekday === "sunday" ? d3.utcSunday : d3.utcMonday
//height = cellSize * (weekday === "weekday" ? 7 : 9)
//width = 954

//years = d3.groups(data, d => d.date.getUTCFullYear()).reverse()

//var svg = d3.select("#some").append("svg").attr("viewBox", [0, 0, width, height * years.length])

//var year = svg.selectAll("g")
//	.data(years)
//	.join("g")
//	.attr("transform", (d, i) => `translate(40.5,${height * i + cellSize * 1.5})`);


//year.append("text")
//	.attr("x", -5)
//	.attr("y", -5)
//	.attr("font-weight", "bold")
//	.attr("text-anchor", "end")
//	.text(([key]) => key);

//year.append("g")
//	.attr("text-anchor", "end")
//	.selectAll("text")
//	.data(weekday === "weekday" ? d3.range(1, 6) : d3.range(7))
//	.join("text")
//	.attr("x" , -5)
//	.attr("y", i => (countDay(i) + 0.5) * cellSize)
//	.attr("dy", "0.31em")
//	.text(formatDay);

//year.append("g")
//	.selectAll("rect")
//	.data(weekday === "weekday"
//		? ([, values]) => values.filter(d => ![0, 6].includes(d.date.getUTCDay()))
//		: ([, values]) => values)
//	.join("rect")
//	.attr("width", cellSize - 2)
//	.attr("height", cellSize - 2)
//	.attr("x", d => timeWeek.count(d3.utcYear(d.date), d.date) * cellSize + 0.5)
//	.attr("y", d => countDay(d.date.getUTCDay()) * cellSize + 0.5)
//	.attr("fill", d => color(d.value))
//	.attr("stroke", d => {
//		if (d.events.find(e => e.type === "macro") == undefined) {
//			return "";
//		}
//		return "blue";
//	})

//var month = year.append("g")
//	.selectAll("g")
//	.data(([, values]) => d3.utcMonths(d3.utcMonth(values[0].date), values[values.length - 1].date))
//	.join("g");

//month.filter((d, i) => i).append("path")
//	.attr("fill", "none")
//	.attr("stroke", "black")
//	.attr("stroke-width", 1)
//	.attr("d", pathMonth);

//month.append("text")
//	.attr("x", d => timeWeek.count(d3.utcYear(d), timeWeek.ceil(d)) * cellSize + 2)
//	.attr("y", -5)
//	.text(formatMonth);

